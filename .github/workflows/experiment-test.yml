name: CI - Experiment Test

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

jobs:
  experiment-test:
    name: Test duato_on_ecube_hypercube Experiment
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential gcc g++ python3 python3-pip curl wget
        
    - name: Install Bazel (Manual - More Stable)
      run: |
        echo "🔧 Installing Bazel manually for better stability..."
        # Install Bazel via apt repository
        curl -fsSL https://bazel.build/bazel-release.pub.gpg | gpg --dearmor >bazel-archive-keyring.gpg
        sudo mv bazel-archive-keyring.gpg /usr/share/keyrings
        echo "deb [arch=amd64 signed-by=/usr/share/keyrings/bazel-archive-keyring.gpg] https://storage.googleapis.com/bazel-apt stable jdk1.8" | sudo tee /etc/apt/sources.list.d/bazel.list
        sudo apt-get update
        sudo apt-get install -y bazel
        bazel --version
        echo "✅ Bazel installed successfully"
        
    - name: Validate CI environment
      run: |
        chmod +x .github/scripts/validate_ci.sh
        .github/scripts/validate_ci.sh
        
    - name: Run experiment test
      run: |
        chmod +x .github/scripts/run_experiment_test.sh
        .github/scripts/run_experiment_test.sh
        
    - name: Quick verification test  
      run: |
        chmod +x .github/scripts/quick_test.sh
        .github/scripts/quick_test.sh
        
    - name: Validate experiment results
      run: |
        echo "🔍 Validating experiment results..."
        
        # Check if any results were generated
        if [ -d "ci_test_results" ] && [ "$(ls -A ci_test_results 2>/dev/null)" ]; then
          echo "✅ CI test results directory contains files"
          ls -la ci_test_results/
        fi
        
        if [ -d "results" ] && [ "$(ls -A results 2>/dev/null)" ]; then
          echo "✅ Main results directory contains files"
          ls -la results/
        fi
        
        if [ -d "exp/duato_on_ecube_hypercube/results" ] && [ "$(ls -A exp/duato_on_ecube_hypercube/results 2>/dev/null)" ]; then
          echo "✅ Experiment-specific results directory contains files"
          ls -la exp/duato_on_ecube_hypercube/results/
        fi
        
        # Check for output logs
        if [ -f "ci_test_results/experiment_output.log" ]; then
          echo "📊 Experiment output summary (last 20 lines):"
          tail -20 ci_test_results/experiment_output.log
        fi
        
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: experiment-test-results
        path: |
          ci_test_results/
          results/
          exp/duato_on_ecube_hypercube/results/
        retention-days: 30
